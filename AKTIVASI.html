<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Anggota Modular</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    .form-container {
      max-width: 480px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .form-group {
      flex: 1 1 calc(50% - 8px);
      display: flex;
      flex-direction: column;
      margin-top: 12px;
    }
    label {
      font-weight: 600;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      margin-top: 25px;
      background: #2e7d32;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
    }
    button:hover {
      background: #1b5e20;
    }
    @media (max-width: 600px) {
      .form-group {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>

  <div class="form-container">
  <h2>Form Aktivasi & Izin Akses Anggota</h2>
  <form id="form-anggota">

    <div class="form-row">
      <div class="form-group">
        <label for="no_id">No ID:</label>
        <input type="text" id="no_id" name="no_id" required>
      </div>
      <div class="form-group">
        <label for="nama">Nama Lengkap:</label>
        <input type="text" id="nama" name="nama" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="alamat">Alamat:</label>
        <input type="text" id="alamat" name="alamat">
      </div>
      <div class="form-group">
        <label for="instansi">Instansi:</label>
        <input type="text" id="instansi" name="instansi">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="jabatan">Jabatan:</label>
        <input list="list-jabatan" id="jabatan" name="jabatan">
        <datalist id="list-jabatan">
          <option value="Anggota">
          <option value="Pimpinan">
          <option value="Sekretaris">
          <option value="Bendahara">
        </datalist>
      </div>
      <div class="form-group">
        <label for="wa">Nomor WA:</label>
        <input type="text" id="wa" name="wa" placeholder="contoh: 6281234567890">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="status">Status:</label>
        <select id="status" name="status">
          <option value="">-- Pilih Status --</option>
          <option value="Aktif">Aktif</option>
          <option value="Non Aktif">Non Aktif</option>
        </select>
      </div>
      <div class="form-group">
        <label for="user_aktif">User Aktif:</label>
        <select id="user_aktif" name="user_aktif">
          <option value="">-- Pilih Role --</option>
          <option value="user">user</option>
          <option value="admin">admin</option>
          <option value="super admin">super admin</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="dimulai_pada">Dimulai Pada:</label>
        <input type="date" id="dimulai_pada" name="dimulai_pada" required>
      </div>
      <div class="form-group">
        <label for="berakhir_pada">Berakhir Pada:</label>
        <input type="date" id="berakhir_pada" name="berakhir_pada" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="masa_jabatan">Masa Jabatan (bulan):</label>
        <input type="number" id="masa_jabatan" name="masa_jabatan" readonly>
      </div>
    </div>

    <button type="submit">Simpan</button>
  </form>
</div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const { createClient } = window.supabase;
    const supabase = createClient(
      'https://brnqpdvtninzyqqwhmfj.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc'
    );

    // Auto-fill saat no_id diketik
    document.getElementById('no_id').addEventListener('input', async function () {
      const noId = this.value.trim();
      if (noId.length < 3) return;

      const { data, error } = await supabase
        .from('tb_anggota')
        .select('nama, alamat, instansi, wa, email, status')
        .eq('no_id', noId)
        .single();

      if (error || !data) return;

      document.getElementById('nama').value = data.nama || '';
      document.getElementById('alamat').value = data.alamat || '';
      document.getElementById('instansi').value = data.instansi || '';
      document.getElementById('wa').value = data.wa || '';
      document.getElementById('email').value = data.email || '';
      document.getElementById('status').value = data.status || '';
    });

    // Hitung masa jabatan dari tanggal
    function hitungTanggal() {
      const mulai = document.getElementById('dimulai_pada').value;
      const akhir = document.getElementById('berakhir_pada').value;
      if (mulai && akhir) {
        const tglMulai = new Date(mulai);
        const tglAkhir = new Date(akhir);
        const bulan = (tglAkhir.getFullYear() - tglMulai.getFullYear()) * 12 +
                      (tglAkhir.getMonth() - tglMulai.getMonth());
        document.getElementById('masa_jabatan').value = bulan;
      }
    }

    document.getElementById('dimulai_pada').addEventListener('change', hitungTanggal);
    document.getElementById('berakhir_pada').addEventListener('change', hitungTanggal);

// Simpan data anggota
document.getElementById('form-anggota').addEventListener('submit', async function(e) {
  e.preventDefault();

  const noId = document.getElementById('no_id').value.trim();
  const wa = document.getElementById('wa').value.trim();

  if (!noId) {
    alert("No ID wajib diisi.");
    return;
  }

  if (!wa.startsWith('628')) {
    alert("Nomor WA harus dimulai dengan 628.");
    document.getElementById('wa').focus();
    return;
  }

  // Cek apakah no_id sudah ada
  const { data: existing, error: cekError } = await supabase
    .from('tb_anggota')
    .select('id')
    .eq('no_id', noId)
    .limit(1);

  const payload = {
    no_id: noId,
    nama: document.getElementById('nama').value,
    alamat: document.getElementById('alamat').value,
    instansi: document.getElementById('instansi').value,
    jabatan: document.getElementById('jabatan').value,
    wa: wa,
    status: document.getElementById('status').value,
    email: document.getElementById('email').value,
    user_aktif: document.getElementById('user_aktif').value,
    dimulai_pada: document.getElementById('dimulai_pada').value,
    berakhir_pada: document.getElementById('berakhir_pada').value,
    masa_jabatan: parseInt(document.getElementById('masa_jabatan').value)
  };

  let simpanError;

  if (existing && existing.length > 0) {
    // üîÅ Update baris yang sudah ada
    const { error } = await supabase
      .from('tb_anggota')
      .update(payload)
      .eq('id', existing[0].id);
    simpanError = error;
  } else {
    // üÜï Insert baru
    const { error } = await supabase
      .from('tb_anggota')
      .insert([payload]);
    simpanError = error;
  }

  if (simpanError) {
    alert("Gagal simpan: " + simpanError.message);
  } else {
    alert("Data berhasil disimpan!");
    document.getElementById('form-anggota').reset();
    document.getElementById('masa_jabatan').value = '';
  }
});
});
</script>